<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wiki‑in‑a‑Box</title>
    <meta name="color-scheme" content="light dark" />
    <style>
      :root {
        --primary-50:#eff6ff; --primary-100:#dbeafe; --primary-200:#bfdbfe; --primary-300:#93c5fd; --primary-400:#60a5fa; --primary-500:#3b82f6; --primary-600:#2563eb; --primary-700:#1d4ed8; --primary-800:#1e40af; --primary-900:#1e3a8a;
        --neutral-50:#f9fafb; --neutral-100:#f3f4f6; --neutral-200:#e5e7eb; --neutral-300:#d1d5db; --neutral-400:#9ca3af; --neutral-500:#6b7280; --neutral-600:#4b5563; --neutral-700:#374151; --neutral-800:#1f2937; --neutral-900:#111827;
        --success:#10b981; --warning:#f59e0b; --error:#ef4444;
        --shadow-md:0 4px 12px rgba(0,0,0,.08);
        --radius:12px; --radius-sm:8px; --radius-pill:999px;
      }
      @media (prefers-color-scheme: dark) {
        :root { --neutral-50:#111827; --neutral-100:#111827; --neutral-200:#1f2937; --neutral-300:#374151; --neutral-400:#6b7280; --neutral-500:#9ca3af; --neutral-600:#d1d5db; --neutral-700:#e5e7eb; --neutral-800:#f3f4f6; --neutral-900:#ffffff; }
      }
      * { box-sizing: border-box; }
      html,body { height:100%; }
      body {
        margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
        color: var(--neutral-900);
        background: linear-gradient(135deg, var(--primary-50), #ffffff 40%);
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      }
      .app { min-height:100%; display:flex; flex-direction:column; }
      header {
        position:sticky; top:0; z-index:10;
        background: rgba(255,255,255,.8);
        backdrop-filter: blur(12px);
        border-bottom:1px solid var(--neutral-200);
      }
      .bar { max-width: 980px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
      .brand { display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; }
      .logo { width:28px; height:28px; border-radius:10px; display:grid; place-items:center; color:white; background: linear-gradient(135deg, var(--primary-600), var(--primary-800)); box-shadow: inset 0 0 10px rgba(255,255,255,.12); }
      .status { display:flex; align-items:center; gap:10px; font-size:13px; color: var(--neutral-500); }
      .pill { display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--neutral-200); border-radius: var(--radius-pill); background:#fff; }
      .dot { width:8px; height:8px; border-radius:50%; background: var(--neutral-300); }
      .dot.online { background: var(--success); animation: pulse 2s infinite; }
      .dot.offline { background: var(--error); }
      .meta { display:flex; align-items:center; gap:8px; }
      main { flex:1; }
      .wrap { max-width: 820px; margin: 32px auto; padding: 0 16px; }
      .panel { background: #fff; border:1px solid var(--neutral-200); border-radius: var(--radius); box-shadow: var(--shadow-md); overflow:hidden; }
      .messages { padding: 18px; min-height: 160px; max-height: 60vh; overflow:auto; }
      .flow { display:flex; align-items:center; gap:8px; font-size:13px; color: var(--neutral-500); margin: 0 0 10px 0; }
      .spin { width:14px; height:14px; border-radius:50%; border:2px solid var(--neutral-300); border-top-color: var(--primary-500); animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg);} }
      .pagewrap { display:grid; grid-template-columns: 1fr; gap:12px; }
      .pageframe { width:100%; height: 320px; border:1px solid var(--neutral-200); border-radius: 10px; }
      .flow { display:flex; align-items:center; gap:8px; font-size:13px; color: var(--neutral-500); margin: 0 0 10px 0; }
      .spin { width:14px; height:14px; border-radius:50%; border:2px solid var(--neutral-300); border-top-color: var(--primary-500); animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg);} }
      .citations { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-bottom: 12px; }
      @media (min-width: 900px) { .citations { grid-template-columns: repeat(4, minmax(0,1fr)); } }
      .cite { display:block; padding:10px 12px; border:1px solid var(--neutral-200); border-radius:10px; color: inherit; text-decoration: none; background: var(--neutral-50); transition: .2s ease; }
      .cite:hover, .cite.hl { transform: translateY(-1px); border-color: var(--primary-300); background: var(--primary-50); }
      .cite .t { font-size: 13px; font-weight: 600; color: var(--primary-700); margin-bottom: 4px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }
      .cite .s { font-size: 12px; color: var(--neutral-500); display:-webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow:hidden; }
      .answer { font-size: 15px; line-height: 1.6; color: var(--neutral-800); }
      .answer p { margin: 0 0 10px 0; }
      .answer .ref { cursor: pointer; color: var(--primary-700); text-decoration: none; }
      .answer .ref:hover { text-decoration: underline; }
      .answer strong { font-weight: 650; }
      .input { display:flex; flex-direction:column; gap:8px; padding: 14px; border-top:1px solid var(--neutral-200); background: var(--neutral-50); }
      .row { display:flex; gap:8px; align-items:flex-end; }
      textarea { flex:1; border:1px solid var(--neutral-200); border-radius: 10px; padding: 10px 12px; resize: none; min-height: 44px; max-height: 140px; font: inherit; background:#fff; }
      textarea:focus { outline:none; border-color: var(--primary-500); box-shadow: 0 0 0 3px rgba(59,130,246,.12); }
      .btn { border:1px solid var(--neutral-200); background:#fff; color: var(--neutral-800); border-radius: 10px; padding: 10px 14px; font-weight:600; cursor:pointer; transition:.2s; }
      .btn.primary { background: var(--primary-600); color: #fff; border-color: var(--primary-600); }
      .btn:disabled { opacity:.6; cursor:not-allowed; }
      .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-md); }
      .hint { display:flex; justify-content:space-between; font-size:12px; color: var(--neutral-500); }
      .toast { position: fixed; bottom: 16px; right: 16px; background:#fff; border:1px solid var(--neutral-200); border-radius: 10px; padding: 10px 12px; box-shadow: var(--shadow-md); color: var(--neutral-800); display:none; }
      .toast.show { display:block; }
      @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }
      @media (prefers-color-scheme: dark) {
        body { background: linear-gradient(135deg, #0b1020, #0e0f12); color: #e6e8ee; }
        header { background: rgba(12,13,18,.6); border-color: #1f2533; }
        .pill { background: rgba(20,22,28,.9); border-color:#262c3a; color:#c7cbda; }
        .panel { background: #10131b; border-color:#1d2332; }
        .messages { color:#d6d9e2; }
        .cite { background: #0f1422; border-color:#1d2434; }
        .cite:hover { background:#0f162a; }
        .answer { color:#cfd4e3; }
        .input { background:#0d111a; border-color:#1d2332; }
        textarea { background:#0f1420; border-color:#20273a; color:#dbe2f4; }
        .btn { background:#121827; color:#e3e7f1; border-color:#222b3e; }
        .btn.primary { background: linear-gradient(135deg, #2563eb, #1d4ed8); border-color:transparent; }
        .toast { background:#0f1420; border-color:#242b3d; color:#e3e7f1; }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div class="bar">
          <div class="brand">
            <div class="logo" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2l-5 9h10l-5-9z"/><rect x="3" y="11" width="7" height="11" rx="1"/><rect x="14" y="11" width="7" height="11" rx="1"/>
              </svg>
            </div>
            Wiki‑in‑a‑Box
          </div>
          <div class="status">
            <div class="pill" id="connPill"><span class="dot" id="connDot"></span><span id="connText">Connecting…</span></div>
            <div class="meta">
              <div class="pill" title="Model"><strong>Model</strong>: <span id="modelName">—</span></div>
              <div class="pill" title="Title Index"><strong>Index</strong>: <span id="indexStatus">—</span></div>
            </div>
          </div>
        </div>
      </header>
      <main>
        <div class="wrap">
          <div class="panel" role="region" aria-label="Chat panel">
            <div class="messages">
              <div id="pagewrap" class="pagewrap" style="display:none;">
                <iframe id="pageframe" class="pageframe" title="Article preview" src="about:blank"></iframe>
              </div>
              <div id="flow" class="flow" style="display:none;"><div class="spin"></div><div class="t">Working…</div></div>
              <div class="citations" id="citations"></div>
              <div class="answer" id="answer" aria-live="polite"></div>
            </div>
            <div class="input">
              <div class="row">
                <textarea id="q" placeholder="Ask about anything in local Wikipedia…" rows="1" maxlength="800"></textarea>
                <button id="ask" class="btn primary">Ask</button>
                <button id="cancel" class="btn" disabled>Cancel</button>
              </div>
              <div class="hint"><span>Enter to send · Shift+Enter for newline</span><span><span id="count">0</span>/800</span></div>
            </div>
          </div>
        </div>
      </main>
      <div class="toast" id="toast"></div>
    </div>
    <script>
      const els = {
        dot: document.getElementById('connDot'),
        text: document.getElementById('connText'),
        model: document.getElementById('modelName'),
        index: document.getElementById('indexStatus'),
        q: document.getElementById('q'),
        ask: document.getElementById('ask'),
        cancel: document.getElementById('cancel'),
        citations: document.getElementById('citations'),
        answer: document.getElementById('answer'),
        toast: document.getElementById('toast'),
        count: document.getElementById('count')
      };

      let controller = null;
      let isStreaming = false;

      function showToast(msg) { els.toast.textContent = msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'), 3500); }
      function setConn(status, label) {
        els.dot.classList.remove('online','offline');
        if (status === 'online') els.dot.classList.add('online');
        if (status === 'offline') els.dot.classList.add('offline');
        els.text.textContent = label;
      }
      function escapeHTML(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
      function installRefHandlers() {
        // highlight on hover; click opens the matching citation card link
        els.answer.querySelectorAll('.ref[data-ref]').forEach(el => {
          const id = el.getAttribute('data-ref');
          el.addEventListener('mouseenter', () => highlightCite(id, true));
          el.addEventListener('mouseleave', () => highlightCite(id, false));
          el.addEventListener('click', (e) => {
            e.preventDefault();
            const card = els.citations.querySelector(`.cite[data-cite-id="${id}"]`);
            if (card && card.href) window.open(card.href, '_blank', 'noopener,noreferrer');
          });
        });
      }

      function renderAnswer(text) {
        // basic paragraphs + line breaks, safe by escaping first
        // Also wrap numeric citation markers with clickable spans to link to cards.
        // Supports ASCII [] and common full‑width brackets: ［］ and 【】.
        const safe = escapeHTML(text).replace(/(?:\[(\d+)\]|［(\d+)］|【(\d+)】)/g, (_m, a, b, c) => {
          const n = a || b || c; return `<sup class="ref" data-ref="${n}">[${n}]<\/sup>`;
        });
        const parts = safe.split(/\n\n+/).map(p => `<p>${p.replace(/\n/g,'<br>')}</p>`).join('');
        els.answer.innerHTML = parts || '';
        installRefHandlers();
      }
      
      function renderCitations(list) {
        els.citations.innerHTML = '';
        for (const c of (list || []).slice(0,4)) {
          const path = (c.url || '').replace(/^\/kiwix/, '');
          const href = `${location.origin}${location.pathname}?path=${encodeURIComponent(path)}`;
          const a = document.createElement('a');
          a.className = 'cite'; a.href = href; a.target = '_blank'; a.rel = 'noopener noreferrer';
          if (typeof c.id !== 'undefined') a.setAttribute('data-cite-id', String(c.id));
          a.innerHTML = `<div class="t">${escapeHTML(c.title || 'Article')}</div><div class="s">${escapeHTML(c.snippet || '')}</div>`;
          els.citations.appendChild(a);
        }
      }

      function highlightCite(id, on) {
        if (!id) return;
        els.citations.querySelectorAll(`.cite[data-cite-id="${id}"]`).forEach(card => {
          if (on) card.classList.add('hl'); else card.classList.remove('hl');
        });
      }

      function setFlow(msg) {
        const f = document.getElementById('flow');
        const t = f && f.querySelector('.t');
        if (!f || !t) return;
        if (!msg) { f.style.display = 'none'; t.textContent = ''; return; }
        t.textContent = msg; f.style.display = 'flex';
      }

      let API_BASE = '/api'; // prefer Nginx proxy if present
      let KIWIX_BASE = '/kiwix';
      
      async function pickApiBase() {
        // Try Nginx first
        try {
          const r = await fetch('/api/health', { cache:'no-store' });
          if (r.ok) { API_BASE = '/api'; KIWIX_BASE = '/kiwix'; return true; }
        } catch (_) {}
        // Fallback to direct ports (dev)
        try {
          const r = await fetch('http://localhost:8000/api/health', { cache:'no-store' });
          if (r.ok) { API_BASE = 'http://localhost:8000/api'; KIWIX_BASE = 'http://localhost:8080'; return true; }
        } catch (_) {}
        return false;
      }

      async function health() {
        try {
          setConn('loading','Connecting…');
          if (!await pickApiBase()) throw new Error('No API');
          const r = await fetch(API_BASE + '/health', { cache:'no-store' });
          if (!r.ok) throw new Error('HTTP '+r.status);
          const j = await r.json();
          els.model.textContent = (j.model_name || '—').toString();
          const ready = j.indices && typeof j.indices.zim_present === 'boolean' ? j.indices.zim_present : undefined;
          els.index.textContent = ready === true ? 'Ready' : ready === false ? 'Not Available' : '—';
          setConn('online','Connected');
        } catch (e) {
          setConn('offline','Disconnected');
        }
      }

      function updateCount() {
        const v = els.q.value; els.count.textContent = v.length;
        // autoresize
        els.q.style.height = 'auto';
        const max = 140; const h = Math.min(els.q.scrollHeight, max); els.q.style.height = h+'px';
      }

      async function ask() {
        const question = els.q.value.trim();
        if (!question || isStreaming) return;
        els.answer.textContent = '';
        renderCitations([]);
        setFlow('Searching titles (FTS5 + suggestions)…');
        isStreaming = true; els.ask.disabled = true; els.cancel.disabled = false;
        controller = new AbortController();
        let buffer = '';
        let eventType = null;
        let dataLines = [];
        let answerBuf = '';
        try {
          const endpoint = PAGE_PATH ? '/answer_from_page' : '/chat';
          const body = PAGE_PATH ? { path: PAGE_PATH, question, k: 4 } : { question, k: 4 };
          const res = await fetch(API_BASE + endpoint, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body), signal: controller.signal });
          if (!res.ok || !res.body) { const text = await res.text(); throw new Error(text || ('HTTP '+res.status)); }
          const reader = res.body.getReader(); const dec = new TextDecoder();
          let done = false;
          while (!done) {
            const chunk = await reader.read(); done = chunk.done; if (chunk.value) buffer += dec.decode(chunk.value, { stream: true });
            let idx;
            while ((idx = buffer.indexOf('\n')) >= 0) {
              const line = buffer.slice(0, idx); buffer = buffer.slice(idx+1);
              if (line.startsWith('event:')) { eventType = line.slice(6).trim(); continue; }
              if (line.startsWith('data:')) { dataLines.push(line.slice(5).trimStart()); continue; }
              if (line === '') {
                if (dataLines.length) {
                  const dataStr = dataLines.join('\n'); dataLines = [];
                  try {
                    const payload = dataStr ? JSON.parse(dataStr) : {};
                    if (eventType === 'citations' && payload.citations) {
                      renderCitations(payload.citations);
                      const n = (payload.citations || []).length;
                      const model = (els.model.textContent || 'the model');
                      setFlow(`Found ${Math.min(n,4)} source${n===1?'':'s'}. Generating with ${model}…`);
                    } else if (eventType === 'token' && typeof payload.token === 'string') {
                      answerBuf += payload.token; renderAnswer(answerBuf);
                      // auto-scroll
                      const messages = document.querySelector('.messages'); messages.scrollTop = messages.scrollHeight;
                    } else if (eventType === 'reasoning') {
                      // ignore in UI (debug stream)
                    } else if (eventType === 'done') {
                      setFlow('');
                      done = true; break;
                    }
                  } catch (e) { /* ignore bad frame */ }
                }
                eventType = null;
              }
            }
          }
        } catch (err) {
          if (err.name !== 'AbortError') showToast('Failed to get response');
        } finally {
          isStreaming = false; els.ask.disabled = false; els.cancel.disabled = true; controller = null;
        }
      }

      els.ask.addEventListener('click', () => ask());
      els.cancel.addEventListener('click', () => { if (controller) controller.abort(); });
      els.q.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); ask(); } });
      els.q.addEventListener('input', updateCount);
      updateCount();

      // Page-scoped chat mode (works with Nginx and dev serve)
      let PAGE_PATH = null;
      const params = new URLSearchParams(location.search);
      const pth = params.get('path');
      if (pth) {
        PAGE_PATH = pth.startsWith('/') ? pth : '/' + pth;
        const wrap = document.createElement('div');
        wrap.id = 'pagewrap'; wrap.className = 'pagewrap';
        const frame = document.createElement('iframe');
        frame.id = 'pageframe'; frame.className = 'pageframe'; frame.title = 'Article preview';
        frame.src = KIWIX_BASE + PAGE_PATH;
        const messages = document.querySelector('.messages');
        if (messages) { messages.insertBefore(wrap, messages.firstChild); wrap.appendChild(frame); }
      }


      health();
      setInterval(health, 30000);
    </script>
  </body>
  </html>
